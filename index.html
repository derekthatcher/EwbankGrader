<html>
<head>
  <title>Ewbank Grader</title>
  <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<style>
  body {
    text-align: left;
  }

  h1 {
    text-align: center;
  }

  .container {
    display: flex;
    flex-wrap: wrap;
    /* Important for mobile responsiveness */
  }

  .column {
    flex: 1;
    /* Equal width columns by default */
    padding: 20px;
    box-sizing: border-box;
    /* Include padding in width calculations */
  }

  .error {
    border: 2px solid red;
    background-color: #ecafaf;
  }

  #calibration {
    padding: 0 18px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background-color: #f1f1f1;
  }

  #calibration.show {
    max-height: 500px;
    /* Or any large number */
  }

  .collapsible {
    margin-top:20px;
    background-color: #ebe9e9;
  }

  /* Mobile Styles (adjust breakpoint as needed) */
  @media (max-width: 600px) {
    .column {
      flex: 1 0 100%;
      /* Make each column full width on mobile */
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body>
  <h1 id="title">Ewbank Grader</h1>
  <div class="container">
    <div class="column">
      <div id="text">Enter strings like "25 N 25 G V6", Ewbank or V-grades for very short sections. Rest options are N, B, M and G.
      </div>
      <input type="text" id="input" name="input" size="80"><br>
      <div>
        <h3>Grade: <span id="output"></span></h3>
      </div>
      <button id="save">Save to local storage</button><br>
      <div class="collapsible"><strong>Calibration</strong></div>
      <div id="calibration">
        <div>To calibrate - think about two climbs of the same grade stacked on top of each other, one pair with no rest and another with a good rest between. 
          Set N to be the no rest increase in grade, and G to be the good rest increase. 
          By default N is 2.5, which means if you stack two 25s with no rest, you get a 27.5 (a 27/28).
          A good rest would add 1.75 grades.
        </div>
        <input type="range" id="sliderN" min="1" max="4" step="0.01" value="2.5">
        <div id="sliderOutputN">No rest change: 2.5</div>
        <input type="range" id="sliderG" min="1" max="4" step="0.01" value="1.75">
        <div id="sliderOutputG">Good rest change: 1.75</div>
        <canvas id="myChart"></canvas>
      </div>
    </div>
    <div class="column">
      <ul id="climbList"></ul>
    </div>
  </div>
  <script>
    /**************************************
      Constants and Variables
    **************************************/
    let ewbankClimbList = []; //load from local storage
    const sliderN = document.getElementById("sliderN");
    const sliderG = document.getElementById("sliderG");
    const climbString = document.getElementById("input");
    const sliderOutputN = document.getElementById("sliderOutputN");
    const sliderOutputG = document.getElementById("sliderOutputG");
    const collapsible = document.querySelector(".collapsible");
    const content = document.querySelector("#calibration");
    let climbListUL = document.getElementById("climbList");
    const gradeUpperBounds = { "soft": 0.74, "middle": 0, "hard": 0.24, "slash": 0.49 };
    const ctx = document.getElementById('myChart').getContext('2d');
    let graph = null;

    /**************************************
      Functions
      take string like "32 N 20 B 25" and return single grade.
    **************************************/
    climbString.addEventListener("input", function () {
      gradeIt();
    });

    document.querySelector("#save").addEventListener("click", function () {
      // save current state to local storage json object.
      ewbankClimbList.push({ 'climbString': climbString.value, 'sliderN': sliderN.value, 'sliderG': sliderG.value, 'grade': solve(formatGradeString(climbString.value)) });
      localStorage.setItem("ewbankClimbList", JSON.stringify(ewbankClimbList));
      updateClimbList()
      console.log(ewbankClimbList);
    });

    sliderN.addEventListener("input", function () {
      sliderOutputN.textContent = "No rest change: " + sliderN.value;
      gradeIt();
      graphIt();
    });

    sliderG.addEventListener("input", function () {
      sliderOutputG.textContent = "Good rest change: " + sliderG.value;
      gradeIt();
      graphIt();
    });

    collapsible.addEventListener("click", function () {
      this.classList.toggle("active");
      if (content.classList.contains('show')) {
        content.classList.remove("show");
      }
      else {
        content.classList.add("show");
      }

    });

    function gradeIt() {
      // deal with different data strings
      // 25n25g28 etc v5bv5 
      // need to recursively solve - need lots of error checking.
      let input = formatGradeString(climbString.value);
      if (input != "Error") {
        result = solve(input);
        climbString.classList.remove("error");
        document.getElementById('output').innerHTML = translateGradeValue(result) + " | " + Math.round(result * 100) / 100;
      } else {
        climbString.classList.add("error");
      }
    };

    function graphIt() {
      // Check if a chart instance already exists.
      if (graph) {
        // Destroy the existing chart instance.
        graph.destroy();
      }
      let quadraticData = [[], [], [], []];
      let restOptions = ["N", "B", "M", "G"];
      for (i = 0; i < 4; i++) {
        restValue = getRestValue(restOptions[i]);
        console.log("rest: " + restValue);
        let a = ((4 - restValue) / 64)
        let b = (restValue / 8) - 8 * a;
        let c = 0;
        for (let x = -8; x <= 8; x += 1) {
          quadraticData[i].push({ x: x, y: a * (x + 8) * (x + 8) + b * (x + 8) + c });
        }
      }
      graph = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'No Rest',
            data: quadraticData[0],
            borderColor: '#0000FF',
            fill: false
          }, {
            label: 'Bad Rest',
            data: quadraticData[1],
            borderColor: '#0080FF',
            fill: false
          }, {
            label: 'Moderate Rest',
            data: quadraticData[2],
            borderColor: '#4682B4',
            fill: false
          }, {
            label: 'Good Rest',
            data: quadraticData[3],
            borderColor: '#5F9EA0',
            fill: false
          }]
        },
        options: {
          scales: {
            x: {
              type: 'linear',
              position: 'bottom',
              title: { display: true, text: 'Relative second grade', },
              min: -8, // Set the minimum x-value
              max: 8  // Set the maximum x-value
            },
            y: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Relative result grade', },
            }
          }
        }
      });
    }

    function solve(inputString) {
      gradeArray = inputString.split(" ");
      if (gradeArray.length === 3) {
        return addTwoEwbank(gradeArray[0], gradeArray[1], gradeArray[2]);
      } else if (gradeArray.length < 3) {
        return "Error";
      } else {
        // split
        startString = gradeArray[0] + " " + gradeArray[1] + " " + gradeArray[2];
        endString = inputString.slice(startString.length);
        newString = addTwoEwbank(gradeArray[0], gradeArray[1], gradeArray[2]) + endString;
        return solve(newString);
      }
    }

    // take 20 "B" 25 and return single grade.
    function addTwoEwbank(start, rest, end) {
      start = Number(start);
      end = Number(end);
      if (!isNaN(start) && !isNaN(end)) {
        restValue = getRestValue(rest);
        //test basic conditions
        if (start <= (end - 8)) {
          return end;
        }
        if (end <= (start - 8)) {
          return start;
        }


        // Find a
        let a = ((4 - restValue) / 64)
        // Find b
        let b = 0.5;
        // Find c
        let c = start;
        console.log("a: " + a + " b: " + b + "c: " + c);
        // Find quadratic.
        let x = end - start;
        return Math.round((a * x * x + b * x + c + restValue) * 100) / 100;
      } else {
        console.log("non number input: " + start + " or " + end);
        return "Error";
      }
    }

    function formatGradeString(inputString) {
      if (typeof inputString !== 'string') {
        return "Error";
      }
      if (!/[NBMGV]/i.test(inputString)) {
        return "Error";
      }

      const parts = inputString.toUpperCase().split(/[NBGM]+/); // Split by N, B, M, G, case-insensitive
      const separators = inputString.toUpperCase().match(/[NBGM]+/g) || []; // Extract separators

      let formattedString = "";
      let partIndex = 0;
      let separatorIndex = 0;

      while (partIndex < parts.length) {
        let part = parts[partIndex].trim(); // Remove leading/trailing spaces
        if (part) {
          // deal with Vgrades 
          if(part.toUpperCase().startsWith("V")){
            part = convertVgrade(part.toUpperCase(), !partIndex);
          }
          if (!isNaN(parseFloat(part))) {
            if (formattedString) { // Add space if it's not the first part
              formattedString += " ";
            }
            formattedString += parseFloat(part); // Ensure number is parsed as float
          } else {
            return "Error";
          }
        }

        if (separatorIndex < separators.length) {
          formattedString += " " + separators[separatorIndex];
          separatorIndex++;
        }
        partIndex++;
      }
      return formattedString.trim(); // Remove trailing spaces
    }

    function convertVgrade(Vgrade, isAtStart){
      // takes a Vgrade string "V6" and returns 26.3 (first) or 28 (second) 
      // https://www.desmos.com/calculator/a7n2mkrfw7
      let grade = Number(Vgrade.split("V")[1]);
      if(grade < 5){
        grade += 20;
      }else if (grade > 7.5) {
        grade += 22;
      } else {
        grade = 1.5*grade + 17.5;
      }
      //adjust for if at start of route or later.
      if(isAtStart){
        grade -= 0.7;
      } else {
        grade += 1;
      }
      return grade;
    }

    function getRestValue(restType) {
      // take rest type and value from sliders
      restGaps = { "G": 0, "M": 1, "B": 2, "N": 3 };
      return Number(restGaps[restType] * (sliderN.value - sliderG.value) / 3) + Number(sliderG.value);
    }

    function translateGradeValue(gradeValue) {
      // take deciaml grade and output a string like [29 | 8a | 5.13a].Soft
      // or 29.soft
      let wholeGrade = Math.floor(gradeValue);
      let decimal = gradeValue - wholeGrade;
      if (decimal > gradeUpperBounds.soft) {
        return (wholeGrade + 1) + ".soft";
      } else if (decimal > gradeUpperBounds.slash) {
        return wholeGrade + "/" + (wholeGrade + 1);
      } else if (decimal > gradeUpperBounds.hard) {
        return wholeGrade + ".hard";
      } else {
        return wholeGrade;
      }
    }

    function updateClimbList() {
      // Clear existing list items before adding new ones
      while (climbListUL.firstChild) {
        climbListUL.removeChild(climbListUL.firstChild);
      }

      // Loop through the climb list and add items to the list
      ewbankClimbList.forEach(function (climb, index) {
        // Create the input field
        let nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = climb.name || ""; // Use climb.name or an empty string
        nameInput.classList.add("listName");

        let listItem = document.createElement("li");
        let climbText = document.createTextNode(" " + climb.climbString + " = " + climb.grade + " [" + climb.sliderG + ".." + climb.sliderN + "]");
        // Create the delete button
        let deleteButton = document.createElement("button");
        deleteButton.textContent = "X";
        deleteButton.addEventListener("click", function () {
          ewbankClimbList.splice(index, 1); // Remove the item from the array
          localStorage.setItem("ewbankClimbList", JSON.stringify(ewbankClimbList)); // Update local storage
          updateClimbList(); // Re-render the list
        });
        listItem.appendChild(nameInput);
        listItem.appendChild(climbText);
        listItem.appendChild(deleteButton);
        climbListUL.appendChild(listItem);

        // Add the listener for tab out (blur event)
        nameInput.addEventListener("blur", function () {
          // Update the climb object in the array
          ewbankClimbList[index].name = nameInput.value;
          // Update local storage with the modified array
          localStorage.setItem("ewbankClimbList", JSON.stringify(ewbankClimbList));
        });
      });
    }

    // onload event
    document.addEventListener("DOMContentLoaded", function () {
      // Retrieve the climb list from local storage
      ewbankClimbList = JSON.parse(localStorage.getItem("ewbankClimbList")) || [];
      updateClimbList();
      graphIt()
    });


  </script>